---
title: "The Development of Color Terms in Shipibo-Konibo Children"
author: "Danielle Kellier*, Martin Fortier*, Maria Fernández Flecha, and Michael C. Frank"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: html_document
---

```{r setup, include=FALSE, echo=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DT)
library(ggthemes)
library(cowplot)
library(viridis)
library(english)
library(lme4)
library(nnet)

source("../helpers/load_and_process.R")
predicted_range <- seq(6,10, 0.25)


```


###Study 1
<!-- Methods -->
<!-- Participants.  -->

```{r study1_participants, include=FALSE}
study1_participants <- read_csv("../data/Current_Data/naming_colors_participants.csv") %>%
  mutate(age = as.numeric(as.character(edad)),
         `edad aprendizaje del espanol` = as.numeric(as.character(`edad aprendizaje del espanol`))) %>%
  summarise(mean_age = round(mean(age, na.rm = T), 1),
            median_age = round(median(age, na.rm = T), 1),
            sd_age = round(sd(age, na.rm = T), 1),
            min_age = min(age, na.rm = T),
            max_age = max(age, na.rm = T),
            mean_spanish = round(mean(`edad aprendizaje del espanol`, na.rm = T), 1),
            median_spanish = round(median(`edad aprendizaje del espanol`, na.rm = T), 1),
            sd_spanish = round(sd(`edad aprendizaje del espanol`, na.rm = T), 1),
            min_spanish = min(`edad aprendizaje del espanol`, na.rm = T),
            max_spanish = max(`edad aprendizaje del espanol`, na.rm = T),
            num_men = sum(género == 'masculino'),
            num_total = n())

study1_occupations <- read_csv("../data/Current_Data/naming_colors_participants.csv") %>%
  group_by(género, ocupación) %>%
  summarise (n = n()) %>%
  group_by(género) %>%
  mutate(freq_gender = 100*n / sum(n)) %>%
  ungroup() %>%
  mutate(freq_total = 100*n / sum(n))

```

<!-- We recruited `r study1_participants$num_total` adult participants (`r study1_participants$num_men` men). Most of participants were from SK communities of the Middle Ucayali region (from Yarinacocha, San Francisco, and Nueva Betania), but some of them were from communities of the Lower (Paoyhan) and Upper (Puerto Belen) Ucayali. In Yarinacocha (a small town located in the vicinity of Pucallpa), participants were recruited in Bena Jema, a neighborhood where most of the inhabitants are SK. All the other places where participants were recruited were native community villages exclusively inhabited by SK people. Overall, the sample included both somewhat urbanized SK (Yarinacocha and San Francisco) and SK still used to more traditional activities and regular contact with the surrounding rainforest (Nueva Betania, Paoyhan, and Puerto Belen). …. The median age for participants was roughly `r study1_participants$median_age` years with a range between `r study1_participants$min_age` to `r study1_participants$max_age` years of age (SD = `r study1_participants$sd_age`yo). Regarding occupations, `r round(filter(study1_occupations, género == 'femenino' & ocupación == 'ama de casa')$freq_gender)`% of the women were homemakers (`r round(filter(study1_occupations, género == 'femenino' & ocupación == 'ama de casa')$freq_total)`% overall) and another `r round(filter(study1_occupations, género == 'femenino' & ocupación == 'artesana')$freq_gender)`% were artisans (`r round(filter(study1_occupations, género == 'femenino' & ocupación == 'artesana')$freq_total)`%). `tools::toTitleCase(as.character(as.english(filter(study1_occupations, género == 'masculino' & ocupación == 'agricultor')$n)))` of the `r summarize(filter(study1_occupations, género == 'masculino'), n = sum(n))$n` men were horticulturalists (`r round(filter(study1_occupations, género == 'masculino' & ocupación == 'agricultor')$freq_gender)`%, `r round(filter(study1_occupations, género == 'masculino' & ocupación == 'agricultor')$freq_total)`% overall). `r tools::toTitleCase(as.character(as.english(filter(study1_occupations, género == 'femenino' & ocupación == 'estudiante')$n)))` women (`r round(filter(study1_occupations, género == 'femenino' & ocupación == 'estudiante')$freq_gender)`%, `r round(filter(study1_occupations, género == 'femenino' & ocupación == 'estudiante')$freq_total)`% overall) and `r as.character(as.english(filter(study1_occupations, género == 'masculino' & ocupación == 'estudiante')$n))` men (`r round(filter(study1_occupations, género == 'masculino' & ocupación == 'estudiante')$freq_gender)`%, `r round(filter(study1_occupations, género == 'masculino' & ocupación == 'estudiante')$freq_total)`% overall) identified as students. Although all adult participants spoke Shipibo-Konibo as a first language, all started learning Spanish before early adolescence (median = `r study1_participants$median_spanish`yo, SD = `r study1_participants$sd_spanish`y). -->
 
<!-- Materials. -->
<!-- Procedure. -->
Results and Discussion
```{r study1_commonterms, include=FALSE}

study1_profusion <- naming_data %>%
  group_by(subj, color_cat) %>%
  summarise(n = n()) %>%
  group_by(color_cat) %>%
  spread(subj, n, fill = 0) %>%
  gather(key = 'subj', value = 'n', -color_cat) %>%
  mutate(prop = 100*n/165) %>%
  summarise(`% of Subjects Who Used the Term (Current)` = 100*sum(prop > 0)/n(), 
            `Mean % of Chips in Set Labeled (Current)` = mean(prop),
            `SD % of Chips in Set Labeled (Current)` = sd(prop))

curr_naming_list <- as.character(na.omit(filter(study1_profusion, `% of Subjects Who Used the Term (Current)` > 50 & !is.na(color_cat))$`color_cat`))

study1_switchperc <- naming_data %>%
  mutate(spanish_response = ifelse(color_cat %in% spanish_terms,
                                   1, 0)) %>%
  mutate(overall_spanish = paste0(round(100*mean(spanish_response), 0),"%")) %>%
  group_by(subj) %>%
  summarise(overall_spanish = first(overall_spanish),
            atleast_1 = ifelse(sum(spanish_response) > 0, 1, 0),
            by_subject = mean(spanish_response)) %>% 
  ungroup() %>%
  summarise(overall_spanish = first(overall_spanish),
            atleast_1 = paste0(round(100*mean(atleast_1), 0),"%"),
            mean_subj_spanish = paste0(round(100*mean(by_subject)),"%"),
            sd_subj_spanish = paste0(round(100*sd(by_subject)),"%"),
            max_subj_spanish = paste0(round(100*max(by_subject)),"%"),
            min_subj_spanish = paste0(round(100*min(by_subject)),"%"))

study1_spanishbychip <- naming_data %>%
  mutate(spanish_response = ifelse(color_cat %in% spanish_terms,
                                   1, 0)) %>%
  select(subj, chip_id, spanish_response) %>%
  mutate(set = ifelse((chip_id %% 2) == 0, 'even', 'odd')) %>%
  split(.$set) %>%
  map_df(function(x) {
    x %>%
      group_by(chip_id) %>%
      summarise(perc = mean(spanish_response))
  }) %>%
  left_join(color_chip_data %>% select("#cnum", "hex"),
            by = c("chip_id" = "#cnum")) %>%
  arrange(desc(perc)) %>%
  rename(`Chip ID` = chip_id, `% of Subjects` = perc, `Hex Code` = hex)

study1_highestspanish <- datatable(study1_spanishbychip, rownames = FALSE) %>%
  formatPercentage("% of Subjects", 0) %>%
  formatStyle(columns = "Hex Code",
              background = styleEqual(
                study1_spanishbychip$`Hex Code`, study1_spanishbychip$`Hex Code`))


```


All participants described at least 1 chip with the following set of color terms: light/white (“joxo”), dark/black (“wiso”), yellow (“panshin”), red (“joshin”), and green/blue (“yankon”). Most (`r paste0(round(filter(study1_profusion, color_cat == "Manxan")$'% of Subjects Who Used the Term (Current)'), '%')`) participants also used described at least 1 chip as faded or "manxan", referring to a chip's saturation. In terms of overall popularity, participants on average described `r paste0(round(filter(study1_profusion, color_cat == "Yankon")$'Mean % of Chips in Set Labeled (Current)'), '%')` of chips as "yankon" (*SD* = `r paste0(round(filter(study1_profusion, color_cat == "Yankon")$'SD % of Chips in Set Labeled (Current)'), '%')`) followed by "joshin" (*M* = `r paste0(round(filter(study1_profusion, color_cat == "Joshin")$'Mean % of Chips in Set Labeled (Current)'), '%')`, *SD* = `r paste0(round(filter(study1_profusion, color_cat == "Joshin")$'SD % of Chips in Set Labeled (Current)'), '%')`), "joxo" (`r paste0(round(filter(study1_profusion, color_cat == "Joxo")$'Mean % of Chips in Set Labeled (Current)'), '%')`, `r paste0(round(filter(study1_profusion, color_cat == "Joxo")$'SD % of Chips in Set Labeled (Current)'), '%')`), "panshin" (`r paste0(round(filter(study1_profusion, color_cat == "Panshin")$'Mean % of Chips in Set Labeled (Current)'), '%')`, `r paste0(round(filter(study1_profusion, color_cat == "Panshin")$'SD % of Chips in Set Labeled (Current)'), '%')`), "manxan" (`r paste0(round(filter(study1_profusion, color_cat == "Manxan")$'Mean % of Chips in Set Labeled (Current)'), '%')`, `r paste0(round(filter(study1_profusion, color_cat == "Manxan")$'SD % of Chips in Set Labeled (Current)'), '%')`), and "wiso" (`r paste0(round(filter(study1_profusion, color_cat == "Wiso")$'Mean % of Chips in Set Labeled (Current)'), '%')`, `r paste0(round(filter(study1_profusion, color_cat == "Wiso")$'SD % of Chips in Set Labeled (Current)'), '%')`).

One departure from the Berlin-Kay data was that `r study1_switchperc$atleast_1` of adults described at least 1 chip using a Spanish-language color term, accounting for `r study1_switchperc$overall_spanish` of all responses (Figure 1a-b). In particular, spanish use reached as high as `r round(100*max(study1_spanishbychip$'% of Subjects'))`% when participants were asked to label chips that English speakers would consider to be orange. However, there was a high amount of variability in Spanish use between subjects (*M* = `r study1_switchperc$mean_subj_spanish`, *SD* = `r study1_switchperc$sd_subj_spanish`) with some subjects never responding in Spanish. One responded in Spanish for `r study1_switchperc$min_subj_spanish` of all trials despite all sessions being conducted entirely in the Shipibo-Konibo language.

<!--<br>

`r study1_highestspanish` 
<br>-->

```{r study1_moredetail, include=FALSE}

study1_consensus <- naming_data %>%
  select(subj, chip_id, color_cat) %>%
  mutate(set = ifelse((chip_id %% 2) == 0, 'even', 'odd')) %>%
  split(.$set) %>%
  map_df(function(x) {
    x %>%
      group_by(chip_id, color_cat) %>%
      summarise(n = n()) %>%
      group_by(chip_id) %>%
      mutate(perc = 100*n/sum(n)) %>%
      select(-n)
  }) %>%
  arrange(chip_id) %>%
  rename(`Chip ID` = chip_id, `Color Term` = color_cat, `% of Subjects` = perc) 


```

**Nature of terms used**
```{r study1_termnature, include = FALSE}
study1_nature <- naming_data %>%
  mutate(spanish_response = ifelse(color_cat %in% spanish_terms, 1, 0)) %>%
  group_by(subj, spanish_response, nature) %>%
  summarise(n = n()) %>% ungroup() %>%
  mutate(nature = ifelse(is.na(nature), "Other", nature)) %>%
  complete(subj, spanish_response, nature, fill = list(n = 0)) %>%
  group_by(subj) %>%
  mutate(perc = 100*n/sum(n)) %>%
  group_by(spanish_response, nature) %>%
  summarise(mean_prop = paste0(round(mean(perc)), '%'),
            sd_prop = paste0(round(sd(perc)), '%'))
  
```

Participants on average described `r filter(study1_nature, nature == "BCT" & spanish_response == 0)$mean_prop` of chips using a SK-language basic color term like "yankon" (*SD* = `r filter(study1_nature, nature == "BCT" & spanish_response == 0)$sd_prop`). Some participants described chips using SK-language ad hoc color terms, such as "nai" or *sky* for blue chips (*M* = `r filter(study1_nature, nature == "AHCT" & spanish_response == 0)$mean_prop`, *SD* = `r filter(study1_nature, nature == "AHCT" & spanish_response == 0)$sd_prop`), or ad hoc terms referring to saturation or luminosity of a chip, such as "manxan" (*M* = `r filter(study1_nature, nature == "AHCT - SLT" & spanish_response == 0)$mean_prop`, *SD* = `r filter(study1_nature, nature == "AHCT - SLT" & spanish_response == 0)$sd_prop`). Virtually all instances where a participant responded in Spanish involved a Spanish basic color term such as "rojo" (*M* = `r filter(study1_nature, nature == "BCT" & spanish_response == 1)$mean_prop`, *SD* = `r filter(study1_nature, nature == "BCT" & spanish_response == 1)$sd_prop`). In other words, participants only responded in Spanish to label chips into basic categories but relied on Shipibo-Konibo all other descriptor types.

**Gender differences in term profusion or term appearance**
```{r, study1_genderdifferences, include = FALSE}
study1_genderbychip <- naming_data %>%
  group_by(género) %>%
  mutate(gender_count = n_distinct(subj)) %>%
  group_by(chip_id, género, color_cat, gender_count) %>%
  summarise(n = n()) %>%
  mutate(prop = n/gender_count) %>%
  select(-gender_count, -n) %>% ungroup() %>%
  complete(chip_id, género, color_cat, fill = list(prop = 0))

study1_genderbyterm <- naming_data %>%
  group_by(subj, género, color_cat) %>%
  summarise(prop = n()/165) %>% ungroup() %>%
  complete(nesting(subj, género), color_cat, fill = list(prop = 0))

study1_ttest_gendertermprofusion <- with(
  study1_genderbyterm %>% 
   group_by(color_cat, género) %>%
   summarise(prop = mean(prop)) %>%
   spread(género, prop), t.test(femenino, masculino))

study1_ttest_gendertermappearance <- with(
  study1_genderbyterm %>% 
    mutate(used = ifelse(prop > 0, 1, 0)) %>%
    group_by(color_cat, género) %>%
    summarise(prop = mean(used)) %>%
    spread(género, prop), t.test(femenino, masculino))

```

We speculated as to whether or not there were overall gender differences in responses given during Study 1, especially considering the differences in reported occupations across genders. We found no significant differences in the overall spread of color term usage across the set (*t* = `r study1_ttest_gendertermprofusion$statistic`, *P* = `r study1_ttest_gendertermprofusion$p.value`) or in the percentage of subjects who used a term at least once throughout the task (*t* = `r study1_ttest_gendertermappearance$statistic`, *P* = `r study1_ttest_gendertermappearance$p.value`).

**Entropy analyses**
```{r study1_entropyanalyses, include = FALSE}

study1_entropy <-  study1_consensus %>% 
  mutate(`% of Subjects` = `% of Subjects`/100) %>%
  spread(key = 'Color Term', value = '% of Subjects', fill = 0) %>%
  mutate_if(is.double, funs( . * log(., 
                                     base = n_distinct(study1_consensus$`Color Term`)))) %>%
  mutate_if(is.double, funs(replace(., is.nan(.), 0))) %>%
  ungroup() %>%
  mutate(Entropy = -rowSums(.[-1])) %>%
  select(`Chip ID`, Entropy)

study1_naturebyentropy <-naming_data %>%
  mutate(response_language = case_when(
    color_cat %in% spanish_terms ~ "spanish",
    color_cat %in% shipibo_terms ~ "shipibo"
  )) %>%
  select(subj, chip_id, color_cat, response_language, nature) %>%
  mutate(shipibo_BCT = ifelse(nature == "BCT" & response_language == "shipibo", 1, 0),
         shipibo_AHCT = ifelse(nature == "AHCT" & response_language == "shipibo", 1, 0),
         spanish_BCT = ifelse(nature == "BCT" & response_language == "spanish", 1, 0),
         spanish_AHCT = ifelse(nature == "AHCT" & response_language == "spanish", 1, 0)) %>%
  mutate_at(vars(shipibo_BCT:spanish_AHCT), funs(ifelse(is.na(.), 0, .))) %>%
  group_by(chip_id) %>%
  summarise_at(vars(ends_with("CT", ignore.case = FALSE)), mean, na.rm = TRUE) %>%
  right_join(study1_entropy, by = c("chip_id" = "Chip ID")) %>%
  select(`Chip ID` = chip_id, Entropy, ends_with("CT", ignore.case = FALSE))

## A little circular for a correlation?
study1_naturebyentropy_test <- cor.test(~ shipibo_BCT + Entropy, data = study1_naturebyentropy)

study1_naturebyentropy_plot <- ggplot(study1_naturebyentropy %>% 
         gather(key = "measure", value = "prop", ends_with("CT")) %>%
         separate(measure, c("language", "nature"), sep = "_") %>%
         mutate(language = tools::toTitleCase(language),
                nature = case_when(
                  nature == "BCT" ~ "Basic color term",
                  nature == "AHCT" ~ "Ad-hoc color term"),
                language = relevel(factor(language), ref = "Shipibo"),
                nature = relevel(factor(nature), ref = "Basic color term")),
       aes(x = Entropy, y = prop, group = interaction(language, nature), colour = language, shape = nature)) +
  geom_smooth(method = "loess", aes(fill = language, linetype = nature), alpha = .2) +
  labs(x = "Labelling Entropy of Chip", y = "Proportion of Responses", fill = "Language", color = "Language", linetype = "Nature of Response") +
  scale_fill_viridis(discrete = TRUE, option = "D") +
  scale_color_viridis(discrete = TRUE, option = "D") +
  coord_cartesian(ylim = c(0,1))

```


```{r, echo=FALSE, fig.align='center', warning=FALSE, fig.height = 8, fig.width = 8}

print(study1_naturebyentropy_plot)

```

<br> <br>
###Study 2
<!-- Participants. -->


```{r study2_participants, include=FALSE}

study2_data <- feather::read_feather("../intermediates/processed_data.csv") %>%
  filter(language == "Shipibo", task == "Production") %>%
  mutate(spanish_response = ifelse(response %in% spanish_terms, 1, 0)) 

study2_participants <- study2_data %>%
  group_by(subj) %>%
  filter(row_number() == 1) %>% ungroup() %>%
  summarise(min_age = min(age_interval),
            max_age = max(age_interval),
            num_56 = sum(age_interval %in% 5:6),
            num_78 = sum(age_interval %in% 7:8),
            num_910 = sum(age_interval %in% 9:10),
            num_1112 = sum(age_interval %in% 11:12),
            num_benajema = sum(location == 'bena jema'),
            num_bilingue = sum(location == 'bilingue'),
            num_ccnn = sum(location == 'c.c.n.n. (bahuanisho)'),
            num_boys = sum(gender == "masculino"),
            num_total = n())

study2_agesex <- study2_data %>%
  group_by(subj) %>%
  filter(row_number() == 1) %>% group_by(age_interval) %>%
  summarise(num_total = n(),
            num_boys = sum(gender == 'masculino'),
            mean_age = round(mean(age), 1),
            sd_age = round(sd(age), 2)) %>% ungroup() %>%
  mutate(freq_total = round(100*num_total/sum(num_total)),
         freq_boys = round(100*num_boys/num_total)) %>%
  mutate(`Age Group` = paste0(age_interval, "-years-old"),
         `Age (SD)` = paste0(mean_age, " (", sd_age, ")"),
         `N` = paste0(num_total, " (", freq_total, "%)"),
         `Male` = paste0(num_boys, " (", freq_boys, "%)")) %>%
  select(`Age Group`, `Age (SD)`, `N`, `Male`)

study2_table1 <- datatable(study2_agesex, rownames = FALSE)

```

<!-- The Pontificia Universidad Católica del Perú’s Institutional Review Board approved our study protocol. We recruited `r study2_participants$num_total` `r study2_participants$min_age`- to `r study2_participants$max_age`-year-old children (`r study2_participants$num_boys` boys). Table 1 details the distribution of age and gender. `r tools::toTitleCase(as.character(as.english(with(study2_participants, num_benajema + num_bilingue))))` children were recruited from neighborhoods in Yarinacocha, in the Pucallpa region of Peru, as well as in `r study2_participants$num_ccnn` children from Bawanisho, a native community settled along the Ucayali River, south of Pucallpa. Children were recruited either through their parents or through local schools. When recruited at school, consent for participation was collected from both the teachers and the parents; otherwise, only consent from the parents was collected.   -->

<!--<br>

`r study2_table1` 
<br>-->


<!-- Materials. -->
<!-- Procedure. The production task had a procedure very similar to Study 1, albeit with only 7 chips. We scored whether children produced a color term that was commonly given by adults in Study 1 for that same chip.  -->
Results and Discussion


**Accuracy analyses and Spanish-language responses.**
```{r study2_accuracyspanishentropy, include=FALSE}

study2_overallscore <- study2_data %>%
  group_by(subj, age) %>%
  summarise(correct = mean(correct, na.rm = T))

study2_overallscore_test <- cor.test(~ correct + age, data = study2_overallscore)

study2_overallswitch <- study2_data %>%
  group_by(subj, age) %>%
  summarise(spanish_response = mean(spanish_response))

study2_overallswitch_test <- cor.test(~ spanish_response + age, data = study2_overallswitch)

study2_switchperc <- study2_data %>%
  summarise(spanish_response = paste0(round(100*mean(spanish_response)), "%"))

study2_responsebyentropy <- study2_data %>%
  filter(spanish %in% c("Blanco", "Negro", "Verde", "Amarillo", "Rojo") & 
           (task == "Comprehension" | response_order %in% c("first", "only"))) %>%
  left_join(study1_entropy %>% mutate(`Chip ID` = as.character(`Chip ID`)),
            by = c("prompt" = "Chip ID"))

study2_responsebyentropy$age.years.c <- scale(study2_responsebyentropy$age, scale = FALSE)[,1]

study2_SwitchEnt_model <- summary(lme4::glmer(
  spanish_response ~ age.years.c * Entropy + (1|subj),
  data=study2_responsebyentropy, family = "binomial"))


```


Older children displayed a higher level of overall accuracy in comparison to younger children (*r*(`r study2_overallscore_test$parameter`) = `r round(study2_overallscore_test$estimate, 3)`, *p* `r with(study2_overallscore_test, ifelse(p.value < 0.001, "< 0.001", paste0("= ", round(p.value, 3))))`, see Figure 2). Over a quarter (`r study2_switchperc$spanish_response`) of all responses were given in Spanish. The distribution of Spanish responses was non-random. There was no significant relationship between age and giving a response in a different language (*p* `r with(study2_overallswitch_test, ifelse(p.value < 0.001, "< 0.001", paste0("= ", round(p.value, 3))))` ). However, children tended to respond in Spanish when presented with a chip with low naming consensus (high entropy) among adult participants in Study 1. Even when accounting for between-subject differences and age, this effect remained strong (*p* `r with(study2_SwitchEnt_model, ifelse(coefficients["Entropy", "Pr(>|z|)"] < 0.001, "< 0.001", paste0("= ", round(coefficients["Entropy", "Pr(>|z|)"], 3))))`, see inset entropy values in Figure 2).

**Overextensions.**
```{r study2_overextensions, include=FALSE}

study2_adjacentorswitch_whole <- study2_data %>%
  group_by(subj, age, gender) %>%
  filter(response_order %in% c("first", "only")) %>%
  mutate(correct_nearby = correct + ifelse(is.na(wrong_adjacent), 0, wrong_adjacent),
         correct_all = ifelse(correct + correct_either + correct_nearby > 0, 1, 0)) %>%
  select(subj, age, gender, spanish, starts_with("correct")) %>%
  gather(key = "measure", value = "score", starts_with("correct")) %>%
  mutate(measure = factor(gsub("_","",measure)))

study2_adjacentorswitch_whole$age.years.c <- scale(study2_adjacentorswitch_whole$age, scale = FALSE)[,1]

study2_adjacentorswitch <- study2_adjacentorswitch_whole %>%
  group_by(subj, age, age.years.c, gender, measure) %>%
  summarise(score = mean(score)) %>% ungroup()

study2_AdjSwitchModel <- summary(lme4::glmer(
  score ~ age.years.c * measure + (1|subj),
  data=study2_adjacentorswitch_whole, family = "binomial"))

study2_accuracyloess <- bind_cols(lapply(
  study2_adjacentorswitch %>% split(.$measure),
  function(x){
    as_data_frame(predict(loess(formula = score ~ age, data = x, span = 0.75), 
            newdata = predicted_range, se = TRUE)[c("fit", "se.fit")]) %>%
      rename_all(funs(paste0(first(x$measure),"_",.)))
    })) %>%
  mutate(predicted_age = predicted_range) %>%
  gather(key = "measure", value = "score", starts_with("correct")) %>%
  separate("measure", into = c("measure", "stat"), sep = "_") %>%
  spread(stat, score)
  
# study2_accuracy_plot <- ggplot(study2_accuracyloess,
#   aes(x = predicted_age, y = fit, color = measure, group = measure)) + 
#   geom_line(size = 1) + geom_point(size = 4) +
#   geom_ribbon(aes(ymin = fit - se.fit, ymax = fit + se.fit, group = measure, fill = measure), alpha = .2, colour=NA) +
#   scale_color_viridis(discrete=TRUE, option = "D") +
#   scale_fill_viridis(discrete=TRUE, option = "D")


study2_EucDist <- study2_data %>%
  group_by(subj, age, gender) %>%
  filter(response_order %in% c("first", "only")) %>%
  mutate(wrong_euc_dist = ifelse(correct == 1, NA, wrong_euc_dist)) %>%
  filter(!is.na(wrong_euc_dist))

study2_EucDist$age.years.c <- scale(study2_EucDist$age, scale = FALSE)[,1]

# study2_EucDist_plot <- ggplot(study2_EucDist, aes(y = wrong_euc_dist, x = age)) +
#   geom_point(aes(color = spanish, group = spanish)) +
#   geom_smooth(method = "loess") +
#   scale_colour_manual(values = graph_colors)

study2_EucDist_model <- lme4::lmer(
  wrong_euc_dist ~ age.years.c + (1|subj),
  data=study2_EucDist, REML=FALSE)

study2_EucDist_pchisq <- pchisq(deviance(lm(wrong_euc_dist ~ 1, data=study2_EucDist)) - deviance(study2_EucDist_model), 78, lower.tail=FALSE)

```

The relationship between word entropy and language switching brings up the possibility that children may be using alternative strategies when they lack knowledge of the proper color term mapping. Participants might respond in Spanish if they fail to recall the proper SK color term but do know the proper mapping in the Spanish color system such as labeling a *panshin* chip as "amarillo". They may also choose to respond with a same-language but adjacent color term such as "joshin" for a *panshin*-colored chip. If we allow for more leniency in scoring—accepting same-language, adjacent or different-language, corresponding responses—we can check for more subtlety surrounding color term mapping. Using a mixed-effects model, we found a significant improvement in accuracy scores when we allowed different-language but corresponding responses (*p* `r with(study2_AdjSwitchModel, ifelse(coefficients["measurecorrecteither", "Pr(>|z|)"] < 0.001, "< 0.001", paste0("= ", round(coefficients["measurecorrecteither", "Pr(>|z|)"], 3))))`) but no significant change when allowing for same-language but adjacent responses (*p* `r with(study2_AdjSwitchModel, ifelse(coefficients["measurecorrectnearby", "Pr(>|z|)"] < 0.001, "< 0.001", paste0("= ", round(coefficients["measurecorrectnearby", "Pr(>|z|)"], 3))))`).


```{r study2_termnature, include=FALSE}

study2_allresponsetypes <- study2_data %>%
  filter(response_order %in% c("first", "only", "last")) %>%
  separate_rows(nature, sep = "-") %>%
  mutate(nature = trimws(ifelse(is.na(nature), "Other", nature))) %>%
  group_by(subj, age, response_order, nature) %>%
  summarise(n = n()) %>%
  group_by(subj, age, response_order) %>%
  mutate(prop = n/sum(n)) %>% ungroup() %>%
  complete(nesting(subj, age, response_order), nature, fill = list(n = 0, prop = 0.0))

study2_allresponsetypes_whole <- study2_allresponsetypes %>%
  select(-n) %>%
  spread(nature, prop)

study2_allresponsetypes_whole$age.years.c <- scale(study2_allresponsetypes_whole$age, scale = FALSE)[,1]
study2_allresponsetypes_whole$Y <- as.matrix(study2_allresponsetypes_whole[, c("BCT", "AHCT", "NBCT", "Other", "SLT")])


study2_allresponsetypes_model <- multinom(Y ~ age.years.c + response_order,
                 data=study2_allresponsetypes_whole)


study2_responsedev <- deviance(multinom(Y~1, data=study2_allresponsetypes_whole)) - deviance(multinom(Y ~ age.years.c , data=study2_allresponsetypes_whole))

study2_allresponseloess <- bind_rows(lapply(
  study2_allresponsetypes %>% split(list(.$response_order, .$nature)),
  function(x){
    if (nrow(x) > 0) {
    as_data_frame(predict(loess(formula = prop ~ age, data = x, span = 0.75),
            newdata = predicted_range, se = TRUE)[c("fit", "se.fit")]) %>%
      mutate(predicted_age = predicted_range,
             nature = case_when(
               first(x$nature) == "AHCT" ~ "Ad-hoc color term",
               first(x$nature) == "BCT" ~ "Basic color term",
               first(x$nature) == "NBCT" ~ "Other color term",
               first(x$nature) == "SLT" ~ "Saturation/lightness term",
               TRUE ~ as.character(first(x$nature))),
             response_order = first(x$response_order))
    }}))

# study2_allresponseloess_plot <- ggplot(study2_allresponseloess,
#   aes(x = predicted_age, y = fit, color = nature, group = nature)) +
#   facet_grid(. ~ response_order) +
#   geom_line(size = 1) + geom_point(size = 4) +
#   geom_ribbon(aes(ymin = fit - se.fit, ymax = fit + se.fit, group = nature, fill = nature), alpha = .2, colour=NA) +
#   scale_color_viridis(discrete=TRUE, option = "D") +
#   scale_fill_viridis(discrete=TRUE, option = "D")

  
```

```{r study2_FLTypes, include = FALSE}

study2_FLTypes <- study2_data %>%
  filter(response_order %in% c("first", "last")) %>%
  select(subj, age, prompt, response_order, nature) %>%
  spread(response_order, nature) %>%
  mutate(first_BCT = ifelse(first == "BCT", 1, 0),
         first_AHCT = ifelse(first == "AHCT", 1, 0),
         last_BCT = ifelse(last == "BCT", 1, 0),
         last_AHCT = ifelse(last == "AHCT", 1, 0)) %>%
  group_by(subj, age) %>%
  summarise_at(vars(first_BCT:last_AHCT), mean, na.rm = TRUE)

# study2_FLTypes_plot <- ggplot(study2_FLTypes %>% 
#        gather(key = "measure", value = "prop", first_BCT:last_AHCT),
#        aes(y = prop, x = age, colour = measure, group = measure)) +
#   geom_smooth(method = "loess")

```


##Study 3
<!-- Noting the level of bilingualism in Study 2, we designed Study 3 as its complement. In Study 3, we tested children entirely in Spanish with a set of chips representing prototypical colors for the Spanish color system.  -->


<!-- Methods -->
<!-- Participants.  -->

```{r study3_participants, include=FALSE}

study3_data <- feather::read_feather("../intermediates/processed_data.csv") %>%
  filter(language == "Spanish", task == "Production") %>%
  mutate(shipibo_response = ifelse(response %in% shipibo_terms, 1, 0)) 

study3_participants <- study3_data %>%
  group_by(subj) %>%
  filter(row_number() == 1) %>% ungroup() %>%
  summarise(min_age = min(age_interval),
            max_age = max(age_interval),
            num_56 = sum(age_interval %in% 5:6),
            num_78 = sum(age_interval %in% 7:8),
            num_910 = sum(age_interval %in% 9:10),
            num_1112 = sum(age_interval %in% 11:12),
            num_benajema = sum(location == 'bena jema'),
            num_bilingue = sum(location == 'bilingue'),
            num_ccnn = sum(location == 'c.c.n.n. (bahuanisho)'),
            num_boys = sum(gender == "masculino"),
            num_total = n())

study3_agesex <- study3_data %>%
  group_by(subj) %>%
  filter(row_number() == 1) %>% group_by(age_interval) %>%
  summarise(num_total = n(),
            num_boys = sum(gender == 'masculino'),
            mean_age = round(mean(age), 1),
            sd_age = round(sd(age), 2)) %>% ungroup() %>%
  mutate(freq_total = round(100*num_total/sum(num_total)),
         freq_boys = round(100*num_boys/num_total)) %>%
  mutate(`Age Group` = paste0(age_interval, "-years-old"),
         `Age (SD)` = paste0(mean_age, " (", sd_age, ")"),
         `N` = paste0(num_total, " (", freq_total, "%)"),
         `Male` = paste0(num_boys, " (", freq_boys, "%)")) %>%
  select(`Age Group`, `Age (SD)`, `N`, `Male`)

study3_table1 <- datatable(study3_agesex, rownames = FALSE)

```

<!-- Materials.  -->
<!-- Procedure. -->
Results and Discussion.

```{r study3_spanishentropy, include=FALSE}
study3_switchperc <- study3_data %>%
  group_by(subj) %>%
  summarise(shipibo_response = 100*mean(shipibo_response)) %>%
  ungroup() %>%
  summarise(mean_switch = mean(shipibo_response),
            sd_switch = sd(shipibo_response),
            min_switch = min(shipibo_response),
            max_switch = max(shipibo_response)) %>%
  mutate_all(funs(paste0(round(.),'%')))

study3_overallscore <- study3_data %>%
  group_by(subj, age) %>%
  summarise(correct = mean(correct, na.rm = T))

study3_overallscore_test <- cor.test(~ correct + age, data = study3_overallscore)

study3_overallswitch <- study3_data %>%
  group_by(subj, age) %>%
  summarise(shipibo_response = mean(shipibo_response))

study3_overallswitch_test <- cor.test(~ shipibo_response + age, data = study3_overallswitch)

study3_responsebyentropy <- study3_data %>%
  filter(spanish %in% c("Blanco", "Negro", "Verde", "Amarillo", "Rojo") & 
           (task == "Comprehension" | response_order %in% c("first", "only"))) %>%
  left_join(study1_entropy %>% mutate(`Chip ID` = as.character(`Chip ID`)),
            by = c("prompt" = "Chip ID"))

study3_responsebyentropy$age.years.c <- scale(study3_responsebyentropy$age, scale = FALSE)[,1]

study3_SwitchEnt_model <- summary(lme4::glmer(
  shipibo_response ~ age.years.c * Entropy + (1|subj),
  data=study3_responsebyentropy, family = "binomial"))

```

Similar to Study 2, over a quarter of all responses (*M* = `r study3_switchperc$mean_switch`, *SD* = `r study3_switchperc$sd_switch`) were given in another language (Shipibo in this case). There was significant variation in language-switching with some children completing the entire task in Spanish while others responded to upwards of `r study3_switchperc$max_switch` of trials in Shipibo. Similar to Study 2, there was no significant correlation between age and label accuracy (*p* `r with(study3_overallscore_test, ifelse(p.value < 0.001, "< 0.001", paste0("= ", round(p.value, 3))))`) or between age and language-switching (*p* `r with(study3_overallswitch_test, ifelse(p.value < 0.001, "< 0.001", paste0("= ", round(p.value, 3))))`). Still, we found that participants tended to respond in Shipibo when presented with items that had low entropy among SK adults during Study 1 (p `r with(study3_SwitchEnt_model, ifelse(coefficients["Entropy", "Pr(>|z|)"] < 0.001, "< 0.001", paste0("= ", round(coefficients["Entropy", "Pr(>|z|)"], 3))))`). This suggests that participants across Studies 2 and 3 preferred to respond in Shipibo when presented with a high-consensus chip and in Spanish when shown a low-consensus chip.

**Overextensions.**
```{r study3_overextensions, include=FALSE}

study3_adjacentorswitch_whole <- study3_data %>%
  group_by(subj, age, gender) %>%
  filter(response_order %in% c("first", "only")) %>%
  mutate(correct_nearby = correct + ifelse(is.na(wrong_adjacent), 0, wrong_adjacent),
         correct_all = ifelse(correct + correct_either + correct_nearby > 0, 1, 0)) %>%
  select(subj, age, gender, starts_with("correct")) %>%
  gather(key = "measure", value = "score", starts_with("correct")) %>%
  mutate(measure = factor(gsub("_","",measure)))

study3_adjacentorswitch_whole$age.years.c <- scale(study3_adjacentorswitch_whole$age, scale = FALSE)[,1]

study3_adjacentorswitch <- study3_adjacentorswitch_whole %>%
  group_by(subj, age, age.years.c, gender, measure) %>%
  summarise(score = mean(score)) %>% ungroup()

study3_AdjSwitchModel <- summary(lme4::glmer(
  score ~ age.years.c + measure + (1|subj),
  data=study3_adjacentorswitch_whole, family = "binomial"))

study3_accuracyloess <- bind_cols(lapply(
  study3_adjacentorswitch %>% split(.$measure),
  function(x){
    as_data_frame(predict(loess(formula = score ~ age, data = x, span = 0.75), 
            newdata = predicted_range, se = TRUE)[c("fit", "se.fit")]) %>%
      rename_all(funs(paste0(first(x$measure),"_",.)))
    })) %>%
  mutate(predicted_age = predicted_range) %>%
  gather(key = "measure", value = "score", starts_with("correct")) %>%
  separate("measure", into = c("measure", "stat"), sep = "_") %>%
  spread(stat, score)
  
# study3_accuracy_plot <- ggplot(study3_accuracyloess,
#   aes(x = predicted_age, y = fit, color = measure, group = measure)) + 
#   geom_line(size = 1) + geom_point(size = 4) +
#   geom_ribbon(aes(ymin = fit - se.fit, ymax = fit + se.fit, group = measure, fill = measure), alpha = .2, colour=NA) +
#   scale_color_viridis(discrete=TRUE, option = "D") +
#   scale_fill_viridis(discrete=TRUE, option = "D")

study3_EucDist <- study3_data %>%
  group_by(subj, age, gender) %>%
  filter(response_order %in% c("first", "only")) %>%
  mutate(wrong_euc_dist = ifelse(correct == 1, NA, wrong_euc_dist)) %>%
  filter(!is.na(wrong_euc_dist))

study3_EucDist$age.years.c <- scale(study3_EucDist$age, scale = FALSE)[,1]

# study3_EucDist_plot <- ggplot(study3_EucDist, aes(y = wrong_euc_dist, x = age)) +
#   geom_point(aes(color = spanish, group = spanish)) +
#   geom_smooth(method = "loess") +
#   scale_colour_manual(values = graph_colors)

study3_EucDist_model <- lme4::lmer(
  wrong_euc_dist ~ age.years.c + (1|subj),
  data=study3_EucDist, REML=FALSE)

study3_EucDist_pchisq <- pchisq(deviance(lm(wrong_euc_dist ~ 1, data=study3_EucDist)) - deviance(study3_EucDist_model), 78, lower.tail=FALSE)


```

Similar to Study 2, we adopted alternative scoring to accommodate language-switching from Spanish to Shipibo-Konibo and same-language adjacent responses. Using a mixed-effects model, we did not find that age explained a significant amount of the variation seen in accuracy (*p* `r with(study3_AdjSwitchModel, ifelse(coefficients["age.years.c", "Pr(>|z|)"] < 0.001, "< 0.001", paste0("= ", round(coefficients["age.years.c", "Pr(>|z|)"], 3))))`), in concordance with earlier analyses. However, we did find that participants made use of both mapping strategies of either providing different-language but corresponding responses (*p* `r with(study3_AdjSwitchModel, ifelse(coefficients["measurecorrecteither", "Pr(>|z|)"] < 0.001, "< 0.001", paste0("= ", round(coefficients["measurecorrecteither", "Pr(>|z|)"], 3))))`) or same-language but adjacent responses (*p* `r with(study3_AdjSwitchModel, ifelse(coefficients["measurecorrectnearby", "Pr(>|z|)"] < 0.001, "< 0.001", paste0("= ", round(coefficients["measurecorrectnearby", "Pr(>|z|)"], 3))))`). Between Studies 2 and 3, we find frequent use of language switching but only Study 3 shows significant use of same-language but adjacent terms as well. This discrepancy, along with the lack of an age correlation, can be due to foreign language exposure. Children may be exposed to Spanish at a young age but do not receive any formal Spanish education until later in adolescence. With a limited knowledge of Spanish color terms, children may spontaneously provide Spanish color terms during the Shipibo-language Study 2 but may struggle to succeed during Spanish-language Study 3. This suggests that children may rely on either strategy to communicate a color label to the best of their knowledge set.


```{r study3_termnature, include=FALSE}

study3_allresponsetypes <- study3_data %>%
  filter(response_order %in% c("first", "only", "last")) %>%
  separate_rows(nature, sep = "-") %>%
  mutate(nature = trimws(ifelse(is.na(nature), "Other", nature))) %>%
  group_by(subj, age, response_order, nature) %>%
  summarise(n = n()) %>%
  group_by(subj, age, response_order) %>%
  mutate(prop = n/sum(n)) %>% ungroup() %>%
  complete(nesting(subj, age, response_order), nature, fill = list(n = 0, prop = 0.0))


study3_allresponsetypes_whole <- study3_allresponsetypes %>%
  select(-n) %>%
  spread(nature, prop)

study3_allresponsetypes_whole$age.years.c <- scale(study3_allresponsetypes_whole$age, scale = FALSE)[,1]
study3_allresponsetypes_whole$Y <- as.matrix(study3_allresponsetypes_whole[, c("BCT", "AHCT", "NBCT", "Other", "SLT")])

study3_allresponsetypes_model <- multinom(Y ~ age.years.c + response_order,
                 data=study3_allresponsetypes_whole)

study3_allresponsetypes_dev <- deviance(multinom(Y~1, data=study3_allresponsetypes_whole)) - deviance(study3_allresponsetypes_model)


study3_allresponseloess <- bind_rows(lapply(
  study3_allresponsetypes %>% split(list(.$response_order, .$nature)),
  function(x){
    if (nrow(x) > 0) {
    as_data_frame(predict(loess(formula = prop ~ age, data = x, span = 0.75), 
            newdata = predicted_range, se = TRUE)[c("fit", "se.fit")]) %>%
      mutate(predicted_age = predicted_range, 
             nature = case_when(
               first(x$nature) == "AHCT" ~ "Ad-hoc color term",
               first(x$nature) == "BCT" ~ "Basic color term",
               first(x$nature) == "NBCT" ~ "Other color term",
               first(x$nature) == "SLT" ~ "Saturation/lightness term",
               TRUE ~ as.character(first(x$nature))),
             response_order = first(x$response_order))
    }}))
  
# study3_allresponseloess_plot <- ggplot(study3_allresponseloess,
#   aes(x = predicted_age, y = fit, color = nature, group = nature)) + 
#   facet_grid(. ~ response_order) +
#   geom_line(size = 1) + geom_point(size = 4) +
#   geom_ribbon(aes(ymin = fit - se.fit, ymax = fit + se.fit, group = nature, fill = nature), alpha = .2, colour=NA) +
#   scale_color_viridis(discrete=TRUE, option = "D") +
#   scale_fill_viridis(discrete=TRUE, option = "D")
  
```

```{r study3_FLTypes, include = FALSE}

study3_FLTypes <- study3_data %>% ungroup() %>%
  filter(response_order %in% c("first", "last")) %>%
  select(subj, age, prompt, response_order, nature) %>%
  spread(response_order, nature) %>%
  mutate(first_BCT = ifelse(first == "BCT", 1, 0),
         first_AHCT = ifelse(first == "AHCT", 1, 0),
         last_BCT = ifelse(last == "BCT", 1, 0),
         last_AHCT = ifelse(last == "AHCT", 1, 0)) %>%
  group_by(subj, age) %>%
  summarise_at(vars(first_BCT:last_AHCT), mean, na.rm = TRUE)

ggplot(study3_FLTypes %>% gather(key = "measure", value = "prop", first_BCT:last_AHCT),
       aes(y = prop, x = age, colour = measure, group = measure)) +
  geom_smooth(method = "loess")


study3_FLTypes$age.years.c <- scale(study3_FLTypes$age, scale = FALSE)[,1]
study3_FLTypes$Y <- as.matrix(study3_FLTypes[, c("first_BCT", "first_AHCT", "last_BCT", "last_AHCT")])

study3_allresponsetypes_model <- multinom(Y ~ age.years.c + response_order,
                 data=study3_allresponsetypes_whole)

study3_allresponsetypes_dev <- deviance(multinom(Y~1, data=study3_allresponsetypes_whole)) - deviance(study3_allresponsetypes_model)

pchisq(study3_allresponsetypes_dev, 39+39-2, lower.tail = T)

```


**Comparisons between Studies 2 & 3. - Unfinished plots**

```{r crossstudy_adhoc, include = FALSE}

studies2n3_data <- feather::read_feather("../intermediates/processed_data.csv") %>%
  filter(task == "Production") %>%
  mutate(language = case_when(
      language == "Shipibo" ~ "Study 2",
      language == "Spanish" ~ "Study 3"
    ),
    spanish_response = ifelse(response %in% spanish_terms, 1, 0),
    shipibo_response = ifelse(response %in% shipibo_terms, 1, 0)) %>%
  rename(study = language)

studies2n3_firstresponse_whole <- studies2n3_data %>% ungroup() %>%
  filter(response_order %in% c("first", "only")) %>%
  select(study, subj, age, prompt, nature, spanish_response, shipibo_response) %>%
  left_join(mutate(study1_entropy, `Chip ID` = as.character(`Chip ID`)), 
            by = c("prompt" = "Chip ID"))

studies2n3_firstresponse_whole$age.years.c <- scale(studies2n3_firstresponse_whole$age, scale = FALSE)[,1]
studies2n3_firstresponse_whole$nature <- relevel(studies2n3_firstresponse_whole$nature, ref = "BCT")

study2_naturebyentropy_model <- multinom(nature ~ age.years.c + Entropy + (1:subj),
                 data=filter(studies2n3_firstresponse_whole, study == "Study 2"))
study3_naturebyentropy_model <- multinom(nature ~ age.years.c + Entropy + (1:subj),
                 data=filter(studies2n3_firstresponse_whole, study == "Study 3"))

studies2n3_naturebyentropy_plot <- ggplot(studies2n3_firstresponse_whole %>%
         mutate(BCT = as.numeric(grepl("BCT", nature)),
                AHCT = as.numeric(grepl("AHCT", nature))) %>%
         group_by(study, prompt, Entropy) %>%
         mutate_at(vars(BCT, AHCT), funs(ifelse(is.na(.), 0, .))) %>%
         summarise_at(vars(BCT, AHCT), mean, na.rm = TRUE) %>%
         gather(key = "nature", value = "prop", BCT, AHCT) %>%
         mutate(nature = case_when(
                  nature == "BCT" ~ "Basic Color Term",
                  nature == "AHCT" ~ "Ad-hoc color term"),
                nature = relevel(factor(nature), ref = "Basic Color Term")), 
       aes(x = Entropy, y = prop, group = nature, colour = nature, fill = nature)) +
  facet_grid(. ~ study) +
  geom_smooth(method = "lm") +
  coord_cartesian(ylim = c(0,1)) +
    labs(x = "Labelling Entropy of Chip", y = "Proportion of Responses", color = "Nature of Response", fill = "Nature of Response") +
  scale_color_viridis(discrete=TRUE, option = "D") +
  scale_fill_viridis(discrete=TRUE, option = "D") 

studies2n3_firstresponse <- studies2n3_firstresponse_whole %>%
  group_by(study, subj, age, nature, spanish_response, shipibo_response) %>%
  summarise(n = n()) %>% 
  group_by(study, subj, age) %>%
  mutate(prop = n/sum(n),
         response_language = case_when(
           spanish_response == 1 ~ "spanish",
           shipibo_response == 1 ~ "shipibo",
           TRUE ~ NA_character_
         )) %>% ungroup()


studies2n3_firstresploess <- bind_rows(lapply(
  studies2n3_firstresponse %>% 
    filter(nature %in% c("AHCT", "BCT")) %>%
    split(list(.$study, .$nature, .$response_language)),
  function(x){
    if (nrow(x) > 6) {
    as_data_frame(predict(loess(formula = prop ~ age, data = x, span = 0.75), 
            newdata = predicted_range, se = TRUE)[c("fit", "se.fit")]) %>%
      mutate(predicted_age = predicted_range,
             response_language = tools::toTitleCase(first(x$response_language)),
             study = first(x$study),
             nature = case_when(
               first(x$nature) == "AHCT" ~ "Ad-hoc color term",
               first(x$nature) == "BCT" ~ "Basic color term",
               TRUE ~ "Other"))
    }}))

studies2n3_firstresploess_plot <- ggplot(studies2n3_firstresploess,
  aes(x = predicted_age, y = fit, color = response_language, group = response_language)) + 
  facet_grid(nature ~ study) +
  geom_line(size = 1) + geom_point(size = 4) +
  geom_ribbon(aes(ymin = fit - se.fit, ymax = fit + se.fit, group = response_language, fill = response_language), alpha = .2, colour=NA) +
  scale_color_viridis(discrete=TRUE, option = "D") +
  scale_fill_viridis(discrete=TRUE, option = "D") +
  labs(x = "Age", y = "Proportion of Responses", colour = "Language of Response", fill = "Language of Response") +
  coord_cartesian(ylim = c(0,1))


```


```{r, echo=FALSE, fig.align='center', warning=FALSE, fig.height = 8, fig.width = 8}

print(studies2n3_naturebyentropy_plot)

```

<br>

```{r, echo=FALSE, fig.align='center', warning=FALSE, fig.height = 8, fig.width = 8}

print(studies2n3_firstresploess_plot)

```

```{r crossstudy_accuracystrats, include = FALSE}

studies2n3_allresponseloess_plot <- ggplot(bind_rows(
  list("Study 2" = study2_allresponseloess, "Study 3" = study3_allresponseloess),
  .id = "study") %>%
    mutate(response_order = tools::toTitleCase(as.character(response_order))),
  aes(x = predicted_age, y = fit, color = nature, group = nature)) + 
  facet_grid(response_order ~ study) +
  geom_line(size = 1) + geom_point(size = 4) +
  geom_ribbon(aes(ymin = fit - se.fit, ymax = fit + se.fit, group = nature, fill = nature), alpha = .2, colour=NA) +
    labs(x = "Age", y = "Proportion of Responses", fill = "Nature of Response", color = "Nature of Response") +
  scale_color_viridis(discrete=TRUE, option = "D") +
  scale_fill_viridis(discrete=TRUE, option = "D") +
  coord_cartesian(ylim = c(0,1))

studies2n3_accuracy_plot <- ggplot(
  bind_rows(list("Study 2" = study2_accuracyloess, "Study 3" = study3_accuracyloess), .id = "study") %>%
    mutate(measure = case_when(
      measure == "correct" ~ "Original",
      measure == "correcteither" ~ "Either Language",
      measure == "correctnearby" ~ "Adjacent Color",
      measure == "correctall" ~ "Either + Adjacent")) %>%
    mutate(measure = factor(measure, levels = c("Original", "Either Language", "Adjacent Color", "Either + Adjacent"))),
  aes(x = predicted_age, y = fit, color = measure, group = measure)) + 
  facet_grid(. ~ study) +
  geom_line(size = 1) + geom_point(size = 4) +
  geom_ribbon(aes(ymin = fit - se.fit, ymax = fit + se.fit, group = measure, fill = measure), alpha = .2, colour=NA) +
  labs(x = "Age", y = "Proportion of Responses", fill = "Accuracy", color = "Accuracy") +
  scale_color_viridis(discrete=TRUE, option = "D") +
  scale_fill_viridis(discrete=TRUE, option = "D") +
  coord_cartesian(ylim = c(0,1))

```

```{r, echo=FALSE, fig.align='center', warning=FALSE, fig.height = 8, fig.width = 8}

print(studies2n3_allresponseloess_plot)

```

```{r, echo=FALSE, fig.align='center', warning=FALSE, fig.height = 8, fig.width = 8}

print(studies2n3_accuracy_plot)

```

================================================

## Figures
<br>

```{r adultfigure, include=FALSE}

study1_consensus_plot <- ggplot(study1_consensus %>%
                                 group_by(`Chip ID`) %>%
                                 filter(`% of Subjects` == max(`% of Subjects`)) %>%
                                 left_join(color_chip_data, by = c("Chip ID" = "#cnum")), 
                               aes(x = H, y = V, fill = `Color Term`)) + 
  geom_tile() + 
  scale_size(range = c(0, 2.0)) + 
  scale_fill_manual(name = "Color Term",values = graph_colors) +
  ggtitle("Study 1") +
  guides(fill=guide_legend(ncol=2,byrow=TRUE)) +
  theme(plot.title = element_text(hjust = 0.5))

kay_consensus <- kay_terms %>%
  mutate(Term = ifelse(Term %in% c('Huiso', 'Wiso'), 'Wiso', as.character(Term))) %>%
  group_by(`WCS Chip Number`, Term) %>%
  summarise(n = n()) %>%
  group_by(`WCS Chip Number`) %>%
  mutate(`% of Subjects` = 100*n/sum(n)) %>%
  select(-n) %>%
  group_by(`WCS Chip Number`) %>%
  filter(`% of Subjects` == max(`% of Subjects`)) %>%
  dplyr::rename(`Color Term` = Term, `Chip ID` = `WCS Chip Number`) %>%
  left_join(color_chip_data, by = c("Chip ID" = "#cnum"))


kay_consensus_plot <- ggplot(kay_consensus, 
                             aes(x = H, y = V, fill = `Color Term`)) + 
  geom_tile() + 
  scale_size(range = c(0, 2.0)) + 
  scale_fill_manual(name = "Color Term",values = graph_colors) +
  ggtitle("WCS Data") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5))

study1_spanish_plot <- ggplot(study1_spanishbychip %>%
                               mutate(`% of Subjects` = 100*`% of Subjects`) %>%
                               rename(`Spanish Term` = `% of Subjects`) %>%
                               left_join(select(color_chip_data, `#cnum`, V, H), 
                                         by = c("Chip ID" = "#cnum")), 
                             aes(x = H, y = V)) + 
  geom_tile(aes(fill = `Spanish Term`)) + 
  scale_fill_viridis(option="magma") +
  labs(fill = "Spanish\nUse (%)")

adult_figurelegends <- plot_grid(
  get_legend(study1_consensus_plot),
  NULL,
  get_legend(study1_spanish_plot),
  labels = c("A and B", "", "C"),
  ncol = 3) + 
  theme(plot.margin = unit(c(0.5,0.5,0.5,1), "in")) 

adult_figure <- plot_grid(
  study1_consensus_plot + theme(legend.position = "none"), 
  kay_consensus_plot + theme(legend.position = "none"), 
  study1_spanish_plot + theme(legend.position = "none"), 
  adult_figurelegends, 
  labels = c("A", "B", "C"), ncol = 2
  )

```

```{r, echo=FALSE, fig.align='center', warning=FALSE, fig.height = 8, fig.width = 8}
print(adult_figure)
```

*Figure 1.* (A and B) Plots of the modal term given for a particular chip. Color coordinates were represented in 2-D Munsell space. Modal responses were given by SK adults during (A) the original World Color Survey and during (B) our Study 1. (C) Heat map of prevalence of Spanish-language responses during Study 1. Legends for all three subplots located in the bottom-right quadrant.
<br>

```{r childfigure, include=FALSE}

all_chip_sets <- full_join(shipibo_chip_set, spanish_chip_set) %>%
  left_join(color_chip_data, by = c("chip_id" = "#cnum"))

chip_id_colors <- setNames(all_chip_sets$hex, all_chip_sets$chip_id)

study23_firstprod <- feather::read_feather("../intermediates/processed_data.csv") %>% 
  filter(task == 'Production' & 
           response_order %in% c('first','only') &
           spanish %in% c("Blanco", "Negro", "Verde", "Amarillo", "Rojo",
                          "Morado")
  ) %>%
  group_by(language, age, prompt) %>%
  rename(`Correct (Same Language)` = correct, 
         `Correct (Either Language)` = correct_either) %>%
  gather(key = "criteria", value = "score", 
         `Correct (Same Language)`, `Correct (Either Language)`) %>%
  group_by(language, prompt, age_interval, criteria) %>%
  left_join(study1_entropy %>% 
              mutate(`Chip ID` = as.character(`Chip ID`),
                     Entropy = sprintf("%.2f", round(Entropy,2))), 
            by = c("prompt" = "Chip ID"))

child_figure <- ggplot(study23_firstprod,
                       aes(x = age_interval, y = score, colour = prompt,
                           group = criteria, linetype = criteria, label = Entropy)) +
  geom_smooth(se = FALSE, method = "loess") +
  facet_grid(as.numeric(as.character(prompt)) ~ language) + 
  scale_y_continuous(limits = c(-0.1,1.1), breaks = seq(0,1,0.5), labels = scales::percent) + 
  xlim(c(5,11.5)) +
  scale_color_manual(values = chip_id_colors) +
  scale_linetype_manual(values = c("Correct (Same Language)" = "solid", 
                                   "Correct (Either Language)" = "dotted")) +
  labs(x = "Age", y = "% of Correct Responses", linetype = "Measure", colour = "Chip ID") +
  guides(label = "none") +
  theme(strip.background = element_blank()) +
  geom_label(aes(x = Inf, y = -Inf, hjust = 1.1, vjust = -0.3), 
             show.legend = FALSE, colour = "black")
```

```{r, echo=FALSE, fig.align='center', warning=FALSE}
print(child_figure)
```

*Figure 2*. A comparison of children's performance during the production task in Studies 2 and 3. Solid or dotted lines represent overall performance by age for a particular chip. Solid lines show whether the child gave a correct answer in the language indicated in that column; dotted lines show if they gave a response that was correct in either language. Line colors are representative of the chip’s color coordinates. Values in the lower-right corners of each subplot display the entropy (uncertainty) values calculated from adult responses given during Study 1.



